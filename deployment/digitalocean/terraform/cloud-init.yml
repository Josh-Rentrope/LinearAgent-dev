/*
 * Cloud-init script for LinearAgent droplet
 * Automatically configures the server with Docker, SSL, and application
 */

#cloud-config
package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose
  - nginx
  - certbot
  - python3-certbot-nginx
  - ufw
  - htop
  - curl
  - wget
  - git

runcmd:
  # Start and enable Docker
  - systemctl start docker
  - systemctl enable docker
  - usermod -aG docker ubuntu

  # Create application directory
  - mkdir -p /opt/linear-agent
  - chown ubuntu:ubuntu /opt/linear-agent

  # Create directories for persistent storage
  - mkdir -p /opt/linear-agent/data
  - mkdir -p /opt/linear-agent/logs
  - mkdir -p /opt/linear-agent/ssl
  - mkdir -p /opt/linear-agent/nginx/conf.d

  # Mount persistent volume
  - mkfs.ext4 /dev/disk/by-id/scsi-0DO_Volume_linear-agent-data || true
  - echo '/dev/disk/by-id/scsi-0DO_Volume_linear-agent-data /opt/linear-agent/data ext4 defaults,nofail 0 2' >> /etc/fstab
  - mount -a || true

  # Clone the repository (replace with your repo)
  - cd /opt/linear-agent
  - git clone https://github.com/your-org/LinearAgent.git .

  # Create environment file
  - |
    cat > /opt/linear-agent/.env << EOF
    # Production Configuration
    NODE_ENV=production
    LINEAR_WEBHOOK_PORT=3000
    LINEAR_AGENT_PUBLIC_URL=https://${domain_name}
    
    # Redis Configuration
    REDIS_HOST=${redis_host}
    REDIS_PORT=25061
    REDIS_PASSWORD=${redis_password}
    
    # Security
    JWT_SECRET=${app_secret}
    ENCRYPTION_KEY=${app_secret}
    
    # OpenCode Configuration
    OPENCODE_SERVE_URL=http://localhost:53998
    OPENCODE_SERVE_ENABLED=true
    
    # Logging
    LOG_LEVEL=info
    LOG_FILE=/app/logs/agent.log
    
    # Rate Limiting
    RATE_LIMIT_WINDOW_MS=900000
    RATE_LIMIT_MAX_REQUESTS=100
    
    # Feature Flags
    ENABLE_AI_RESPONSES=true
    ENABLE_OPENCODE_INTEGRATION=true
    ENABLE_ADVANCED_FEATURES=true
    ENABLE_SIGNATURE_VERIFICATION=true
    
    # Add your Linear and OpenCode credentials here
    LINEAR_CLIENT_ID=your_linear_client_id
    LINEAR_CLIENT_SECRET=your_linear_client_secret
    LINEAR_WEBHOOK_SECRET=your_linear_webhook_secret
    LINEAR_API_KEY=your_linear_api_key
    LINEAR_BOT_OAUTH_TOKEN=your_linear_bot_oauth_token
    OPENCODE_API_KEY=your_opencode_api_key
    EOF

  # Set proper permissions
  - chmod 600 /opt/linear-agent/.env
  - chown ubuntu:ubuntu /opt/linear-agent/.env

  # Setup SSL certificates
  - |
    until certbot certonly --nginx --non-interactive --agree-tos --email ${email} -d ${domain_name}; do
      echo "Waiting for DNS propagation..."
      sleep 30
    done

  # Copy SSL certificates to application directory
  - cp /etc/letsencrypt/live/${domain_name}/fullchain.pem /opt/linear-agent/ssl/cert.pem
  - cp /etc/letsencrypt/live/${domain_name}/privkey.pem /opt/linear-agent/ssl/key.pem
  - chown -R ubuntu:ubuntu /opt/linear-agent/ssl

  # Setup automatic SSL renewal
  - |
    cat > /etc/cron.d/certbot-renew << EOF
    0 12 * * * ubuntu /usr/bin/certbot renew --quiet --post-hook "cp /etc/letsencrypt/live/${domain_name}/fullchain.pem /opt/linear-agent/ssl/cert.pem && cp /etc/letsencrypt/live/${domain_name}/privkey.pem /opt/linear-agent/ssl/key.pem && docker-compose -f /opt/linear-agent/docker-compose.yml restart nginx"
    EOF

  # Configure firewall
  - ufw allow ssh
  - ufw allow 80
  - ufw allow 443
  - ufw --force enable

  # Create systemd service
  - |
    cat > /etc/systemd/system/linear-agent.service << 'EOF'
    [Unit]
    Description=LinearAgent - Linear to OpenCode AI Agent
    After=network.target docker.service
    Requires=docker.service

    [Service]
    Type=oneshot
    RemainAfterExit=yes
    WorkingDirectory=/opt/linear-agent
    ExecStart=/usr/bin/docker-compose up -d
    ExecStop=/usr/bin/docker-compose down
    ExecReload=/usr/bin/docker-compose restart
    TimeoutStartSec=0
    Restart=on-failure
    RestartSec=10
    User=ubuntu
    Group=ubuntu

    [Install]
    WantedBy=multi-user.target
    EOF

  # Enable and start the service
  - systemctl daemon-reload
  - systemctl enable linear-agent
  - systemctl start linear-agent

  # Setup log rotation
  - |
    cat > /etc/logrotate.d/linear-agent << EOF
    /opt/linear-agent/logs/*.log {
        daily
        missingok
        rotate 30
        compress
        delaycompress
        notifempty
        create 644 ubuntu ubuntu
        postrotate
            docker-compose -f /opt/linear-agent/docker-compose.yml restart linear-agent
        endscript
    }
    EOF

  # Create monitoring script
  - |
    cat > /opt/linear-agent/monitor.sh << 'EOF'
    #!/bin/bash
    # Health check script for LinearAgent
    
    # Check if containers are running
    if ! docker-compose -f /opt/linear-agent/docker-compose.yml ps | grep -q "Up"; then
        echo "ERROR: Some containers are not running"
        systemctl restart linear-agent
    fi
    
    # Check health endpoint
    if ! curl -f http://localhost/health > /dev/null 2>&1; then
        echo "ERROR: Health check failed"
        systemctl restart linear-agent
    fi
    
    # Check disk space
    DISK_USAGE=$(df /opt/linear-agent/data | tail -1 | awk '{print $5}' | sed 's/%//')
    if [ $DISK_USAGE -gt 80 ]; then
        echo "WARNING: Disk usage is ${DISK_USAGE}%"
    fi
    EOF

  - chmod +x /opt/linear-agent/monitor.sh
  - chown ubuntu:ubuntu /opt/linear-agent/monitor.sh

  # Add monitoring to cron
  - |
    cat > /etc/cron.d/linear-agent-monitor << EOF
    */5 * * * * ubuntu /opt/linear-agent/monitor.sh >> /var/log/linear-agent-monitor.log 2>&1
    EOF

final_message: |
  LinearAgent has been successfully deployed!
  
  Important information:
  - Domain: https://${domain_name}
  - Health check: https://${domain_name}/health
  - Application directory: /opt/linear-agent
  - Logs: /opt/linear-agent/logs
  - Data volume: /opt/linear-agent/data
  
  Next steps:
  1. Update /opt/linear-agent/.env with your Linear and OpenCode credentials
  2. Restart the service: systemctl restart linear-agent
  3. Monitor logs: docker-compose -f /opt/linear-agent/docker-compose.yml logs -f